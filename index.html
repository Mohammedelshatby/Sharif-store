<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ V3</title>
    <style>
        :root { --admin-color: #1e293b; --user-color: #0284c7; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; direction: rtl; text-align: right; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header { background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-right: 10px solid var(--admin-color); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.2s; display: inline-block; }
        .btn-blue { background: var(--user-color); color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .admin-only { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; }
        th { background: #f1f5f9; }
        .print-area { display: none; }
        @media print { .no-print { display: none !important; } .print-area { display: block !important; } }
    </style>
</head>
<body>

<div class="container no-print">
    <div class="header">
        <div>
            <h2 id="stName" style="margin:0;">Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ø¬Ù†Ø¯ÙŠ</h2>
            <small id="userDisplay" style="color:red;">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (admin / 123)</small>
        </div>
        <div id="loginArea" style="display: flex; gap: 5px;">
            <input type="text" id="loginUser" placeholder="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="width:110px; margin:0;">
            <input type="password" id="loginPass" placeholder="Ø§Ù„Ø±Ù…Ø²" style="width:90px; margin:0;">
            <button class="btn-blue" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        </div>
        <button class="btn-red" id="logoutBtn" onclick="localStorage.removeItem('gms_v3_final'); location.reload();" style="display:none;">Ø®Ø±ÙˆØ¬ ÙˆØªØµÙÙŠØ±</button>
    </div>

    <div class="card admin-only" id="adminPanel">
        <h3>âš™ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div style="flex:1; min-width:200px; border:1px solid #eee; padding:10px; border-radius:8px;">
                <label>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù:</label>
                <input type="text" id="newStaffName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="text" id="newStaffPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn-blue" style="width:100%" onclick="addStaff()">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
            </div>
            <div style="flex:1; min-width:200px; border:1px solid #eee; padding:10px; border-radius:8px;">
                <label>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„/Ù…ÙˆØ±Ø¯:</label>
                <input type="text" id="entityName" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <select id="entityType"><option value="Ø¹Ù…ÙŠÙ„">Ø¹Ù…ÙŠÙ„</option><option value="Ù…ÙˆØ±Ø¯">Ù…ÙˆØ±Ø¯</option></select>
                <button class="btn-green" style="width:100%" onclick="addEntity()">Ø­ÙØ¸</button>
            </div>
            <div style="flex:1; min-width:200px; border:1px solid #eee; padding:10px; border-radius:8px;">
                <label>ØªØºÙŠÙŠØ± Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ±:</label>
                <input type="text" id="newAdminPass" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <button class="btn-red" style="width:100%" onclick="changeAdminPass()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…Ø²</button>
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <div class="card admin-only" style="flex: 1; min-width: 250px;">
            <h3>ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
            <input type="text" id="itemName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
            <input type="text" id="itemCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù">
            <button class="btn-blue" style="width:100%" onclick="addItem()">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
        </div>

        <div class="card" style="flex: 2; min-width: 300px;">
            <h3>ğŸ”ƒ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø®Ø²Ù†</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <select id="itemSelect"><option value="">-- Ø§Ø®ØªØ± ØµÙ†Ù --</option></select>
                <input type="text" id="docNum" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†">
                <input type="number" id="qtyInput" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                <select id="entitySelect"><option value="">-- Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆØ±Ø¯ --</option></select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn-green" style="flex:1" onclick="logAction('ÙˆØ§Ø±Ø¯')">ÙˆØ§Ø±Ø¯ (+)</button>
                <button class="btn-red" style="flex:1" onclick="logAction('ØµØ±Ù')">ØµØ±Ù (-)</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:10px;">
            <h3>ğŸ“Š Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø«..." onkeyup="refresh()" style="width:180px; margin:0;">
                <button onclick="window.print()" style="background:#475569; color:white;">Ø·Ø¨Ø§Ø¹Ø©</button>
                <button onclick="exportExcel()" style="background:#166534; color:white;">Excel</button>
            </div>
        </div>
        <table>
            <thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„ØªØ­ÙƒÙ…</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="printArea" class="print-area"></div>

<script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    var data = JSON.parse(localStorage.getItem('gms_v3_final')) || { 
        name: "Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ø¬Ù†Ø¯ÙŠ", adminPass: "123", staff: [], items: [], entities: [], logs: [] 
    };
    var currentUser = null;

    function login() {
        var u = document.getElementById('loginUser').value;
        var p = document.getElementById('loginPass').value;
        
        if(u === "admin" && p === data.adminPass) {
            currentUser = {name: "Ø§Ù„Ù…Ø¯ÙŠØ±", role: "admin"};
        } else {
            var s = data.staff.find(x => x.user === u && x.pass === p);
            if(s) currentUser = {name: s.user, role: "staff"};
        }

        if(currentUser) {
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('userDisplay').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹: " + currentUser.name;
            document.getElementById('userDisplay').style.color = "green";
            if(currentUser.role === "admin") {
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
            }
            refresh();
        } else { alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ø®Ø·Ø£!"); }
    }

    function refresh() {
        localStorage.setItem('gms_v3_final', JSON.stringify(data));
        document.getElementById('stName').innerText = data.name;
        var sTerm = document.getElementById('searchInput').value.toLowerCase();
        
        var iSel = document.getElementById('itemSelect');
        var eSel = document.getElementById('entitySelect');
        iSel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ØµÙ†Ù --</option>';
        eSel.innerHTML = '<option value="">-- Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆØ±Ø¯ --</option>';
        data.items.forEach(i => iSel.innerHTML += <option value="${i.code}">${i.name}</option>);
        data.entities.forEach(e => eSel.innerHTML += <option value="${e.name}">${e.name} (${e.type})</option>);

        var body = document.getElementById('tableBody');
        body.innerHTML = "";
        data.items.forEach((item, index) => {
            if(item.name.toLowerCase().includes(sTerm) || item.code.toLowerCase().includes(sTerm)) {
                var total = 0;
                data.logs.forEach(l => { if(l.code == item.code) total += (l.type=='ÙˆØ§Ø±Ø¯'?l.qty:-l.qty); });
                body.innerHTML += `<tr>
                    <td>${item.code}</td>
                    <td><b>${item.name}</b></td>
                    <td style="font-weight:bold;">${total}</td>
                    <td>
                        <button class="btn-blue" onclick="printCard('${item.code}')">ÙƒØ§Ø±ØªØ©</button>
                        ${currentUser?.role=='admin' ? <button onclick="delItem(${index})" style="color:red; background:none;">ğŸ—‘</button> : ''}
                    </td>
                </tr>`;
            }
        });
    }

    function logAction(type) {
        if(!currentUser) return alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");
        var c = document.getElementById('itemSelect').value, q = parseFloat(document.getElementById('qtyInput').value), d = document.getElementById('docNum').value, e = document.getElementById('entitySelect').value;
        if(c && q && d) {
            data.logs.push({code:c, qty:q, type:type, doc:d, entity:e, date: new Date().toLocaleString(), user: currentUser.name});
            refresh();
            document.getElementById('qtyInput').value = '';
            alert("ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!");
        } else { alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†!"); }
    }

    function addItem() {
        var n = document.getElementById('itemName').value, c = document.getElementById('itemCode').value;
        if(n && c) { data.items.push({name:n, code:c}); refresh(); document.getElementById('itemName').value=''; document.getElementById('itemCode').value=''; }
    }

    function addStaff() {
        var u = document.getElementById('newStaffName').value, p = document.getElementById('newStaffPass').value;
        if(u && p) { data.staff.push({user:u, pass:p}); refresh(); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù"); }
    }

    function addEntity() {
        var n = document.getElementById('entityName').value, t = document.getElementById('entityType').value;
        if(n) { data.entities.push({name:n, type:t}); refresh(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); }
    }

    function printCard(code) {
        var item = data.items.find(i => i.code == code);
        var logs = data.logs.filter(l => l.code == code);
        var html = `<div style="direction:rtl; padding:20px;"><h2>ÙƒØ§Ø±ØªØ©: ${item.name}</h2><table border="1" style="width:100%; border-collapse:collapse;">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥Ø°Ù†</th><th>Ø§Ù„Ø·Ø±Ù</th></tr></thead><tbody>`;
        var b = 0; logs.forEach(l => { b += (l.type=='ÙˆØ§Ø±Ø¯'?l.qty:-l.qty); html += <tr><td>${l.date}</td><td>${l.type}</td><td>${l.qty}</td><td>${l.doc}</td><td>${l.entity}</td></tr>; });
        html += </tbody></table><h3>Ø§Ù„Ø±ØµÙŠØ¯: ${b}</h3></div>;
        document.getElementById('printArea').innerHTML = html; window.print();
    }

    function changeAdminPass() { var p = document.getElementById('newAdminPass').value; if(p) { data.adminPass = p; refresh(); alert("ØªÙ…"); } }
    function changeName() { var n = prompt("Ø§Ù„Ø§Ø³Ù…:", data.name); if(n) { data.name = n; refresh(); } }
    function delItem(i) { if(confirm("Ø­Ø°ÙØŸ")) { data.items.splice(i,1); refresh(); } }
    function exportExcel() {
        var csv = "\uFEFFØ§Ù„ÙƒÙˆØ¯,Ø§Ù„ØµÙ†Ù,Ø§Ù„Ø±ØµÙŠØ¯\n";
        data.items.forEach(i => { var t = 0; data.logs.forEach(l => { if(l.code==i.code) t += (l.type=='ÙˆØ§Ø±Ø¯'?l.qty:-l.qty); }); csv += ${i.code},${i.name},${t}\n; });
        var a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = "Ø¬Ø±Ø¯.csv"; a.click();
    }
    refresh();
</script>
</body>
</html>
