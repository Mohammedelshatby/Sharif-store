<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <style>
        :root { --main: #1e293b; --accent: #0284c7; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; direction: rtl; text-align: right; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header { background: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-right: 10px solid var(--main); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .admin-only { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; }
        th { background: #f1f5f9; color: #475569; }
        .print-area { display: none; }
        @media print { .no-print { display: none !important; } .print-area { display: block !important; } }
    </style>
</head>
<body>

<div class="container no-print">
    <div class="header">
        <div>
            <h1 id="stName" style="margin:0; font-size: 24px;">Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ø¬Ù†Ø¯ÙŠ</h1>
            <p id="userStatus" style="color: #64748b; margin: 5px 0 0 0;">Ø§Ù„Ø­Ø§Ù„Ø©: Ø²Ø§Ø¦Ø±</p>
        </div>
        <div id="authButtons">
            <button class="btn-blue" onclick="requestLogin()">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            <button class="btn-red" id="logoutBtn" style="display:none;" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div class="card admin-only" id="adminPanel" style="flex: 1; min-width: 300px;">
            <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px;">âš™ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
            <input type="text" id="newStaffName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <input type="text" id="newStaffPass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ¸Ù">
            <button class="btn-blue" style="width:100%" onclick="addStaff()">+ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
            <hr>
            <input type="text" id="entityName" placeholder="Ø§Ø³Ù… Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ù…ÙˆØ±Ø¯">
            <select id="entityType"><option value="Ø¹Ù…ÙŠÙ„">Ø¹Ù…ÙŠÙ„</option><option value="Ù…ÙˆØ±Ø¯">Ù…ÙˆØ±Ø¯</option></select>
            <button class="btn-green" style="width:100%" onclick="addEntity()">+ Ø­ÙØ¸ (Ø¹Ù…ÙŠÙ„/Ù…ÙˆØ±Ø¯)</button>
            <hr>
            <input type="text" id="itemName" placeholder="Ø§Ø³Ù… ØµÙ†Ù Ø¬Ø¯ÙŠØ¯">
            <input type="text" id="itemCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù">
            <button class="btn-blue" style="width:100%" onclick="addItem()">+ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ù„Ù„Ù…Ø®Ø²Ù†</button>
        </div>

        <div class="card" style="flex: 2; min-width: 350px;">
            <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px;">ğŸ”ƒ Ø­Ø±ÙƒØ© ÙˆØ§Ø±Ø¯ ÙˆØµØ±Ù</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <select id="itemSelect"><option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù --</option></select>
                <input type="text" id="docNum" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†">
                <input type="number" id="qtyInput" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                <select id="entitySelect"><option value="">-- Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆØ±Ø¯ --</option></select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn-green" style="flex:1" onclick="handleAction('ÙˆØ§Ø±Ø¯')">Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø±Ø¯ (+)</button>
                <button class="btn-red" style="flex:1" onclick="handleAction('ØµØ±Ù')">ØªØ³Ø¬ÙŠÙ„ ØµØ±Ù (-)</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <h3>ğŸ“Š Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø¨Ø­Ø«</h3>
            <div style="display:flex; gap:8px;">
                <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." onkeyup="refreshUI()" style="width:220px; margin:0;">
                <button onclick="window.print()" style="background:#475569; color:white;">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button onclick="exportToExcel()" style="background:#166534; color:white;">Excel</button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="printContainer" class="print-area"></div>

<script>
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let store = JSON.parse(localStorage.getItem('gms_final_system')) || {
        name: "Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ø¬Ù†Ø¯ÙŠ",
        adminPass: "123",
        staff: [],
        items: [],
        entities: [],
        logs: []
    };
    let user = null;

    function requestLogin() {
        let name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (admin Ù„Ù„Ù…Ø¯ÙŠØ±):");
        let pass = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
        
        if (name === "admin" && pass === store.adminPass) {
            user = { name: "Ø§Ù„Ù…Ø¯ÙŠØ±", role: "admin" };
        } else {
            let s = store.staff.find(x => x.u === name && x.p === pass);
            if (s) user = { name: s.u, role: "staff" };
        }

        if (user) {
            document.getElementById('userStatus').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹: " + user.name;
            document.getElementById('userStatus').style.color = "green";
            document.getElementById('logoutBtn').style.display = "inline-block";
            document.querySelectorAll('.btn-blue')[0].style.display = "none";
            if (user.role === "admin") {
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = "block");
            }
            refreshUI();
        } else {
            alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
        }
    }

    function logout() { localStorage.removeItem('gms_final_system'); location.reload(); }

    function refreshUI() {
        localStorage.setItem('gms_final_system', JSON.stringify(store));
        let term = document.getElementById('searchInput').value.toLowerCase();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
        let iSel = document.getElementById('itemSelect');
        let eSel = document.getElementById('entitySelect');
        iSel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù --</option>';
        eSel.innerHTML = '<option value="">-- Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆØ±Ø¯ --</option>';
        store.items.forEach(i => iSel.innerHTML += <option value="${i.c}">${i.n}</option>);
        store.entities.forEach(e => eSel.innerHTML += <option value="${e.n}">${e.n} (${e.t})</option>);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
        let body = document.getElementById('tableBody');
        body.innerHTML = "";
        store.items.forEach((item, idx) => {
            if (item.n.toLowerCase().includes(term) || item.c.toLowerCase().includes(term)) {
                let bal = 0;
                store.logs.forEach(l => { if(l.c == item.c) bal += (l.t=='ÙˆØ§Ø±Ø¯'?l.q:-l.q); });
                body.innerHTML += `<tr>
                    <td>${item.c}</td>
                    <td><b>${item.n}</b></td>
                    <td style="font-weight:bold; color:${bal<0?'red':'black'}">${bal}</td>
                    <td>
                        <button class="btn-blue" onclick="printCard('${item.c}')" style="padding:5px 10px;">ÙƒØ§Ø±ØªØ©</button>
                        ${user?.role == 'admin' ? <button onclick="delItem(${idx})" style="color:red; background:none;">ğŸ—‘</button> : ''}
                    </td>
                </tr>`;
            }
        });
    }

    function handleAction(type) {
        if (!user) return alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");
        let c = document.getElementById('itemSelect').value;
        let q = parseFloat(document.getElementById('qtyInput').value);
        let d = document.getElementById('docNum').value;
        let e = document.getElementById('entitySelect').value;

        if (c && q && d) {
            store.logs.push({ c:c, q:q, t:type, d:d, e:e, dt: new Date().toLocaleString(), u: user.name });
            refreshUI();
            document.getElementById('qtyInput').value = '';
            alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
        } else {
            alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„ØµÙ†ÙØŒ Ø§Ù„ÙƒÙ…ÙŠØ©ØŒ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†");
        }
    }

    function addItem() {
        let n = document.getElementById('itemName').value, c = document.getElementById('itemCode').value;
        if(n && c) { store.items.push({n:n, c:c}); refreshUI(); document.getElementById('itemName').value=''; document.getElementById('itemCode').value=''; }
    }

    function addStaff() {
        let u = document.getElementById('newStaffName').value, p = document.getElementById('newStaffPass').value;
        if(u && p) { store.staff.push({u:u, p:p}); refreshUI(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); }
    }

    function addEntity() {
        let n = document.getElementById('entityName').value, t = document.getElementById('entityType').value;
        if(n) { store.entities.push({n:n, t:t}); refreshUI(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); }
    }

    function printCard(code) {
        let item = store.items.find(i => i.c == code);
        let logs = store.logs.filter(l => l.c == code);
        let html = `<div style="direction:rtl; padding:30px; font-family:sans-serif;">
            <h2>ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ø±ØªØ© ØµÙ†Ù: ${item.n} (${code})</h2>
            <table border="1" style="width:100%; border-collapse:collapse; text-align:center;">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†</th><th>Ø§Ù„Ø·Ø±Ù</th></tr></thead><tbody>`;
        let b = 0;
        logs.forEach(l => { b += (l.t=='ÙˆØ§Ø±Ø¯'?l.q:-l.q); html += <tr><td>${l.dt}</td><td>${l.t}</td><td>${l.q}</td><td>${l.d}</td><td>${l.e}</td></tr>; });
        html += </tbody></table><h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${b}</h3></div>;
        document.getElementById('printContainer').innerHTML = html; window.print();
    }

    function exportToExcel() {
        let csv = "\uFEFFØ§Ù„ÙƒÙˆØ¯,Ø§Ù„ØµÙ†Ù,Ø§Ù„Ø±ØµÙŠØ¯\n";
        store.items.forEach(i => {
            let b = 0; store.logs.forEach(l => { if(l.c==i.c) b += (l.t=='ÙˆØ§Ø±Ø¯'?l.q:-l.q); });
            csv += ${i.c},${i.n},${b}\n;
        });
        let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = "Ø¬Ø±Ø¯.csv"; a.click();
    }

    function delItem(i) { if(confirm("Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ")) { store.items.splice(i,1); refreshUI(); } }

    refreshUI();
</script>
</body>
</html>
