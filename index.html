<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الشريف الجندي V21 - المتكامل</title>
    <style>
        :root { --gold: #D4AF37; --dark: #1a1a1a; --text: #ffffff; }
        body { background-color: var(--dark); color: var(--text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: auto; }
        header { text-align: center; border-bottom: 2px solid var(--gold); padding: 10px; margin-bottom: 20px; }
        h1 { color: var(--gold); margin: 0; font-size: 24px; }
        .auth-bar { background: #333; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px; border: 1px solid var(--gold); }
        .btn { background: var(--gold); color: black; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; transition: 0.3s; }
        .btn:hover { background: #fff; }
        .btn-danger { background: #ff4d4d; color: white; }
        .section { display: none; background: #262626; padding: 15px; border-radius: 10px; border: 1px solid #444; margin-bottom: 20px; }
        .active { display: block; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 5px; border: 1px solid #555; background: #333; color: white; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border: 1px solid #444; padding: 10px; text-align: center; }
        th { background: var(--gold); color: black; }
        .manager-only { border: 2px solid #ff4d4d; background: #2d1a1a; padding: 10px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>نظام الشريف الجندي المتكامل V21</h1>
        <p id="user-status">المستخدم الحالي: <span style="color:var(--gold)">موظف (عرض وإدخال)</span></p>
    </header>

    <div class="auth-bar">
        <button class="btn" onclick="showSection('section-add')">إضافة حركة (وارد/صادر)</button>
        <button class="btn" onclick="showSection('section-inventory')">الجرد والبحث</button>
        <button class="btn" onclick="openManagerMode()">لوحة المدير (سري)</button>
        <button class="btn" onclick="location.reload()">إعادة تنشيط النظام</button>
    </div>

    <div id="section-add" class="section active">
        <h3>تسجيل حركة مخزنية</h3>
        <select id="move-type">
            <option value="وارد">إذن إضافة (وارد من مورد)</option>
            <option value="صادر">إذن صرف (صادر لعميل)</option>
        </select>
        <input type="text" id="item-name" placeholder="اسم الصنف أو الكود">
        <input type="number" id="item-qty" placeholder="الكمية">
        <input type="text" id="person-name" placeholder="اسم (المورد / العميل)">
        <input type="text" id="manual-ref" placeholder="رقم الإذن اليدوي (اختياري)">
        <button class="btn" style="width:100%" onclick="saveMovement()">تأكيد وحفظ العملية</button>
    </div>

    <div id="section-inventory" class="section">
        <h3>جرد المخزن الفوري</h3>
        <input type="text" id="search-box" onkeyup="searchInventory()" placeholder="ابحث بالكود أو اسم الصنف هنا...">
        <table id="inventory-table">
            <thead>
                <tr>
                    <th>الصنف</th>
                    <th>إجمالي الوارد</th>
                    <th>إجمالي الصادر</th>
                    <th>الرصيد الحالي</th>
                </tr>
            </thead>
            <tbody id="inventory-body">
                </tbody>
        </table>
    </div>

    <div id="section-manager" class="section">
        <h3 style="color:#ff4d4d">لوحة تحكم المدير الحصرية</h3>
        <div class="manager-only">
            <button class="btn" onclick="exportToExcel()">تصدير كافة البيانات (Excel)</button>
            <button class="btn btn-danger" onclick="clearAllData()">تصفير النظام بالكامل</button>
        </div>
        <h4>سجل العمليات (للتعديل والحذف)</h4>
        <table id="log-table">
            <thead>
                <tr>
                    <th>التاريخ</th>
                    <th>النوع</th>
                    <th>الصنف</th>
                    <th>الكمية</th>
                    <th>الإجراء</th>
                </tr>
            </thead>
            <tbody id="log-body"></tbody>
        </table>
    </div>
</div>

<script>
    let movements = JSON.parse(localStorage.getItem('shereef_v21_data')) || [];
    let isManager = false;

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'section-inventory') updateInventory();
        if(id === 'section-manager' && isManager) updateLog();
    }

    function saveMovement() {
        const type = document.getElementById('move-type').value;
        const item = document.getElementById('item-name').value;
        const qty = parseFloat(document.getElementById('item-qty').value);
        const person = document.getElementById('person-name').value;
        
        if(!item || !qty) return alert("برجاء إكمال البيانات!");

        const entry = {
            id: Date.now(),
            date: new Date().toLocaleString('ar-EG'),
            type, item, qty, person,
            ref: document.getElementById('manual-ref').value
        };

        movements.push(entry);
        localStorage.setItem('shereef_v21_data', JSON.stringify(movements));
        alert("تم الحفظ بنجاح!");
        document.getElementById('item-qty').value = "";
    }

    function updateInventory() {
        const summary = {};
        movements.forEach(m => {
            if(!summary[m.item]) summary[m.item] = { in: 0, out: 0 };
            if(m.type === 'وارد') summary[m.item].in += m.qty;
            else summary[m.item].out += m.qty;
        });

        const body = document.getElementById('inventory-body');
        body.innerHTML = "";
        for(let item in summary) {
            body.innerHTML += `<tr>
                <td>${item}</td>
                <td>${summary[item].in}</td>
                <td>${summary[item].out}</td>
                <td style="font-weight:bold; color:var(--gold)">${summary[item].in - summary[item].out}</td>
            </tr>`;
        }
    }

    function openManagerMode() {
        const pw = prompt("ادخل كلمة سر المدير:");
        if(pw === "2525") {
            isManager = true;
            document.getElementById('user-status').innerHTML = "المستخدم الحالي: <span style='color:#ff4d4d'>المدير (صلاحيات كاملة)</span>";
            showSection('section-manager');
        } else {
            alert("كلمة سر خاطئة!");
        }
    }

    function updateLog() {
        const body = document.getElementById('log-body');
        body.innerHTML = movements.map(m => `
            <tr>
                <td>${m.date}</td>
                <td>${m.type}</td>
                <td>${m.item}</td>
                <td>${m.qty}</td>
                <td><button onclick="deleteEntry(${m.id})" style="color:red">حذف</button></td>
            </tr>
        `).join('');
    }

    function deleteEntry(id) {
        if(confirm("هل أنت متأكد من حذف هذه العملية؟")) {
            movements = movements.filter(m => m.id !== id);
            localStorage.setItem('shereef_v21_data', JSON.stringify(movements));
            updateLog();
        }
    }

    function clearAllData() {
        if(confirm("تحذير! سيتم مسح كل البيانات نهائياً. هل أنت متأكد؟")) {
            localStorage.removeItem('shereef_v21_data');
            location.reload();
        }
    }

    function exportToExcel() {
        let csv = "التاريخ,النوع,الصنف,الكمية,الجهة,رقم الإذن\n";
        movements.forEach(m => {
            csv += ${m.date},${m.type},${m.item},${m.qty},${m.person},${m.ref}\n;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", "shereef_inventory_report.csv");
        link.click();
    }

    function searchInventory() {
        let filter = document.getElementById('search-box').value.toUpperCase();
        let rows = document.getElementById('inventory-table').getElementsByTagName('tr');
        for (let i = 1; i < rows.length; i++) {
            let td = rows[i].getElementsByTagName('td')[0];
            if (td) {
                rows[i].style.display = td.innerText.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
        }
    }
</script>

</body>
</html>
