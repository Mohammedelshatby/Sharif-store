<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMS Pro V3 | Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <style>
        :root { --admin-color: #1e293b; --user-color: #0284c7; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; direction: rtl; text-align: right; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header { background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-right: 10px solid var(--admin-color); }
        input, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        .btn-blue { background: var(--user-color); color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .admin-only { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; }
        th { background: #f1f5f9; }
        @media print { .no-print { display: none !important; } .print-area { display: block !important; } }
        .print-area { display: none; }
    </style>
</head>
<body>

<div class="container no-print">
    <div class="header">
        <div>
            <h2 id="stName" style="margin:0;">Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ø¬Ù†Ø¯ÙŠ</h2>
            <small id="userDisplay">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„: Ø²Ø§Ø¦Ø± (Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¹Ù…Ù„)</small>
        </div>
        <div id="loginArea">
            <input type="text" id="loginUser" placeholder="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="width:100px;">
            <input type="password" id="loginPass" placeholder="Ø§Ù„Ø±Ù…Ø²" style="width:100px;">
            <button class="btn-blue" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        </div>
        <button class="btn-red" id="logoutBtn" onclick="location.reload()" style="display:none;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="card admin-only" id="adminPanel">
        <h3>âš™ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± (Ù…ÙˆØ¸ÙÙŠÙ† / Ø¹Ù…Ù„Ø§Ø¡ / Ù…ÙˆØ±Ø¯ÙŠÙ†)</h3>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex:1; border:1px solid #eee; padding:10px; border-radius:10px;">
                <input type="text" id="newStaffName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
                <input type="text" id="newStaffPass" placeholder="Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ù„Ù…ÙˆØ¸Ù">
                <button class="btn-blue" style="width:100%" onclick="addStaff()">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
            </div>
            <div style="flex:1; border:1px solid #eee; padding:10px; border-radius:10px;">
                <input type="text" id="entityName" placeholder="Ø§Ø³Ù… Ø¹Ù…ÙŠÙ„/Ù…ÙˆØ±Ø¯">
                <select id="entityType"><option value="Ø¹Ù…ÙŠÙ„">Ø¹Ù…ÙŠÙ„</option><option value="Ù…ÙˆØ±Ø¯">Ù…ÙˆØ±Ø¯</option></select>
                <button class="btn-green" style="width:100%" onclick="addEntity()">Ø­ÙØ¸ Ø§Ù„Ø·Ø±Ù</button>
            </div>
            <div style="flex:1; border:1px solid #eee; padding:10px; border-radius:10px;">
                <input type="text" id="newAdminPass" placeholder="Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ù…Ø¯ÙŠØ± Ø¬Ø¯ÙŠØ¯">
                <button class="btn-red" style="width:100%" onclick="changeAdminPass()">ØªØºÙŠÙŠØ± Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯Ùƒ</button>
                <button class="btn-blue" style="width:100%; margin-top:5px;" onclick="changeName()">ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©</button>
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <div class="card admin-only" style="flex: 1; min-width: 250px;">
            <h3>ğŸ“¦ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="itemName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
            <input type="text" id="itemCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù">
            <button class="btn-blue" style="width:100%" onclick="addItem()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†</button>
        </div>

        <div class="card" style="flex: 2; min-width: 300px;">
            <h3>ğŸ”ƒ Ø­Ø±ÙƒØ© ÙˆØ§Ø±Ø¯ ÙˆØµØ±Ù</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <select id="itemSelect"></select>
                <input type="text" id="docNum" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†">
                <input type="number" id="qtyInput" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                <select id="entitySelect"></select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn-green" style="flex:1" onclick="logAction('ÙˆØ§Ø±Ø¯')">ÙˆØ§Ø±Ø¯ (+)</button>
                <button class="btn-red" style="flex:1" onclick="logAction('ØµØ±Ù')">ØµØ±Ù (-)</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <h3>ğŸ“Š Ø§Ù„Ø¬Ø±Ø¯ ÙˆØ§Ù„Ø¨Ø­Ø«</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." onkeyup="refresh()" style="width:200px; margin:0;">
                <button onclick="window.print()" style="background:#475569; color:white;">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
                <button onclick="exportExcel()" style="background:#166534; color:white;">Excel</button>
            </div>
        </div>
        <table id="mainTable">
            <thead>
                <tr>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                    <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="printArea" class="print-area"></div>

<script>
    var data = JSON.parse(localStorage.getItem('gms_v3_final')) || { 
        name: "Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ø¬Ù†Ø¯ÙŠ", 
        adminPass: "123", 
        staff: [], 
        items: [], 
        entities: [], 
        logs: [] 
    };
    var currentUser = null;

    function login() {
        var u = document.getElementById('loginUser').value;
        var p = document.getElementById('loginPass').value;
        if(u === "admin" && p === data.adminPass) {
            currentUser = {name: "Ø§Ù„Ù…Ø¯ÙŠØ±", role: "admin"};
        } else {
            var s = data.staff.find(x => x.user === u && x.pass === p);
            if(s) currentUser = {name: s.user, role: "staff"};
        }

        if(currentUser) {
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('userDisplay').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹: " + currentUser.name;
            if(currentUser.role === "admin") {
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
            }
            refresh();
        } else { alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ø®Ø·Ø£!"); }
    }

    function refresh() {
        localStorage.setItem('gms_v3_final', JSON.stringify(data));
        document.getElementById('stName').innerText = data.name;
        var sTerm = document.getElementById('searchInput').value.toLowerCase();
        
        var itemSel = document.getElementById('itemSelect');
        var entSel = document.getElementById('entitySelect');
        itemSel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù --</option>'; 
        entSel.innerHTML = '<option value="">-- Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆØ±Ø¯ --</option>';
        
        data.items.forEach(i => itemSel.innerHTML += <option value="${i.code}">${i.name}</option>);
        data.entities.forEach(e => entSel.innerHTML += <option value="${e.name}">${e.name} (${e.type})</option>);

        var body = document.getElementById('tableBody');
        body.innerHTML = "";
        data.items.forEach((item, index) => {
            if(item.name.toLowerCase().includes(sTerm) || item.code.toLowerCase().includes(sTerm)) {
                var total = 0;
                data.logs.forEach(l => { if(l.code == item.code) total += (l.type=='ÙˆØ§Ø±Ø¯'?l.qty:-l.qty); });
                body.innerHTML += `<tr>
                    <td>${item.code}</td>
                    <td><b>${item.name}</b></td>
                    <td style="font-weight:bold; color:${total<0?'red':'black'}">${total}</td>
                    <td>
                        <button class="btn-blue" onclick="printCard('${item.code}')">ğŸ–¨ ÙƒØ§Ø±ØªØ©</button>
                        ${currentUser?.role=='admin' ? <button onclick="delItem(${index})" style="color:red; background:none; font-size:18px;">ğŸ—‘</button> : ''}
                    </td>
                </tr>`;
            }
        });
    }

    function logAction(type) {
        if(!currentUser) return alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");
        var c = document.getElementById('itemSelect').value;
        var q = parseFloat(document.getElementById('qtyInput').value);
        var d = document.getElementById('docNum').value;
        var e = document.getElementById('entitySelect').value;
        if(c && q && d) {
            data.logs.push({code:c, qty:q, type:type, doc:d, entity:e, date: new Date().toLocaleString(), user: currentUser.name});
            refresh();
            document.getElementById('qtyInput').value = '';
            document.getElementById('docNum').value = '';
            alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„!");
        } else { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ (Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù† ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ†Ù)"); }
    }

    function addItem() {
        var n = document.getElementById('itemName').value, c = document.getElementById('itemCode').value;
        if(n && c) { data.items.push({name:n, code:c}); refresh(); document.getElementById('itemName').value=''; document.getElementById('itemCode').value=''; }
    }

    function addStaff() {
        var u = document.getElementById('newStaffName').value, p = document.getElementById('newStaffPass').value;
        if(u && p) { data.staff.push({user:u, pass:p}); refresh(); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù"); }
    }

    function addEntity() {
        var n = document.getElementById('entityName').value, t = document.getElementById('entityType').value;
        if(n) { data.entities.push({name:n, type:t}); refresh(); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø±Ù"); }
    }

    function printCard(code) {
        var item = data.items.find(i => i.code == code);
        var logs = data.logs.filter(l => l.code == code);
        var html = `<div style="direction:rtl; text-align:right; padding:20px;">
                    <h2>ÙƒØ§Ø±ØªØ© ØµÙ†Ù: ${item.name} | ÙƒÙˆØ¯: ${code}</h2>
                    <table border="1" style="width:100%; border-collapse:collapse; text-align:center;">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†</th><th>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</th><th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th></tr></thead><tbody>`;
        var balance = 0;
        logs.forEach(l => {
            balance += (l.type=='ÙˆØ§Ø±Ø¯'?l.qty:-l.qty);
            html += <tr><td>${l.date}</td><td>${l.type}</td><td>${l.qty}</td><td>${l.doc}</td><td>${l.entity || '-'}</td><td>${l.user}</td></tr>;
        });
        html += </tbody></table><h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${balance}</h3></div>;
        var p = document.getElementById('printArea'); p.innerHTML = html; window.print();
    }

    function changeAdminPass() { 
        var p = document.getElementById('newAdminPass').value; 
        if(p) { data.adminPass = p; refresh(); alert("ØªÙ… ØªØºÙŠÙŠØ± Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±"); } 
    }

    function changeName() { var n = prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", data.name); if(n) { data.name = n; refresh(); } }
    function delItem(i) { if(confirm("Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ")) { data.items.splice(i,1); refresh(); } }
    
    function exportExcel() {
        var csv = "\uFEFFØ§Ù„ÙƒÙˆØ¯,Ø§Ù„ØµÙ†Ù,Ø§Ù„Ø±ØµÙŠØ¯\n";
        data.items.forEach(i => {
            var t = 0; data.logs.forEach(l => { if(l.code==i.code) t += (l.type=='ÙˆØ§Ø±Ø¯'?l.qty:-l.qty); });
            csv += ${i.code},${i.name},${t}\n;
        });
        var a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = "Ø¬Ø±Ø¯.csv"; a.click();
    }

    refresh();
</script>
</body>
</html>
