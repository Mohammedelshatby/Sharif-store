<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ø¬Ù†Ø¯ÙŠ V4</title>
    <style>
        :root { --main: #1e293b; --accent: #0284c7; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; direction: rtl; }
        .container { max-width: 1100px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header { background: #1e293b; color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; color: white; transition: 0.3s; }
        .btn-login { background: #0284c7; }
        .btn-add { background: #10b981; width: 100%; }
        .btn-action { background: #4f46e5; flex: 1; }
        .btn-red { background: #ef4444; }
        .admin-section { display: none; background: #fdfdfd; border: 2px dashed #cbd5e1; padding: 15px; border-radius: 10px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; }
        th { background: #f8fafc; color: #1e293b; }
        .no-print { display: block; }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } }
        .print-only { display: none; }
    </style>
</head>
<body>

<div class="container no-print">
    <div class="header">
        <div>
            <h1 style="margin:0;">Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ø¬Ù†Ø¯ÙŠ</h1>
            <p id="userRole" style="margin:5px 0 0 0; font-size:14px; color:#cbd5e1;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...</p>
        </div>
        <button class="btn-login" id="mainLoginBtn" onclick="doLogin()">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <div id="adminPanel" class="admin-section">
        <h3 style="margin-top:0;">âš™ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div class="card">
                <h4>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h4>
                <input type="text" id="staffU" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="text" id="staffP" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn-add" onclick="saveStaff()">+ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
            </div>
            <div class="card">
                <h4>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„/Ù…ÙˆØ±Ø¯</h4>
                <input type="text" id="entN" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <select id="entT"><option value="Ø¹Ù…ÙŠÙ„">Ø¹Ù…ÙŠÙ„</option><option value="Ù…ÙˆØ±Ø¯">Ù…ÙˆØ±Ø¯</option></select>
                <button class="btn-add" onclick="saveEntity()" style="background:#10b981;">+ Ø­ÙØ¸ Ø§Ù„Ø·Ø±Ù</button>
            </div>
            <div class="card">
                <h4>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h4>
                <input type="text" id="itemN" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
                <input type="text" id="itemC" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù">
                <button class="btn-add" onclick="saveItem()" style="background:#4f46e5;">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ”ƒ Ø­Ø±ÙƒØ© ÙˆØ§Ø±Ø¯ ÙˆØµØ±Ù</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <select id="selItem"><option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù --</option></select>
            <input type="text" id="inDoc" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù† (ÙŠØ¯ÙˆÙŠ)">
            <input type="number" id="inQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <select id="selEnt"><option value="">-- Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ù„Ù…ÙˆØ±Ø¯ --</option></select>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-action" onclick="makeLog('ÙˆØ§Ø±Ø¯')" style="background:#10b981;">ÙˆØ§Ø±Ø¯ (+)</button>
            <button class="btn-action" onclick="makeLog('ØµØ±Ù')" style="background:#ef4444;">ØµØ±Ù (-)</button>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>ğŸ“Š Ø§Ù„Ø±ØµÙŠØ¯</h3>
            <input type="text" id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." onkeyup="render()" style="width:250px;">
        </div>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                    <th>Ø§Ù„Ø£Ø¯ÙˆØ§Øª</th>
                </tr>
            </thead>
            <tbody id="mainTbody"></tbody>
        </table>
    </div>
</div>

<div id="printView" class="print-only"></div>

<script>
    // ØªÙ‡ÙŠØ¦Ø© Ø´Ø§Ù…Ù„Ø© ÙˆÙ†Ø¸Ø§Ù… Ø£Ù…Ø§Ù†
    let db = JSON.parse(localStorage.getItem('SHARIF_DB_V4')) || {
        items: [], logs: [], staff: [], entities: [], adminP: "123"
    };
    let user = null;

    function doLogin() {
        let u = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (admin Ù„Ù„Ù…Ø¯ÙŠØ±):");
        let p = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
        
        if(u === "admin" && p === db.adminP) {
            user = { name: "Ø§Ù„Ù…Ø¯ÙŠØ±", role: "admin" };
        } else {
            let found = db.staff.find(s => s.u === u && s.p === p);
            if(found) user = { name: u, role: "staff" };
        }

        if(user) {
            document.getElementById('mainLoginBtn').innerText = "Ø®Ø±ÙˆØ¬";
            document.getElementById('mainLoginBtn').onclick = () => { localStorage.removeItem('SHARIF_DB_V4'); location.reload(); };
            document.getElementById('userRole').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹: " + user.name;
            if(user.role === "admin") document.getElementById('adminPanel').style.display = "block";
            render();
        } else { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!"); }
    }

    function render() {
        localStorage.setItem('SHARIF_DB_V4', JSON.stringify(db));
        let term = document.getElementById('search').value.toLowerCase();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
        document.getElementById('selItem').innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù --</option>' + db.items.map(i => <option value="${i.c}">${i.n}</option>).join('');
        document.getElementById('selEnt').innerHTML = '<option value="">-- Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ù„Ù…ÙˆØ±Ø¯ --</option>' + db.entities.map(e => <option value="${e.n}">${e.n}</option>).join('');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
        let html = "";
        db.items.forEach((item, idx) => {
            if(item.n.toLowerCase().includes(term) || item.c.toLowerCase().includes(term)) {
                let bal = 0;
                db.logs.forEach(l => { if(l.c == item.c) bal += (l.t == 'ÙˆØ§Ø±Ø¯' ? l.q : -l.q); });
                html += `<tr>
                    <td>${item.c}</td>
                    <td><b>${item.n}</b></td>
                    <td>${bal}</td>
                    <td>
                        <button onclick="printC('${item.c}')" style="background:#0284c7; padding:5px 10px;">ÙƒØ§Ø±ØªØ©</button>
                        ${user?.role=='admin' ? <button onclick="delI(${idx})" style="background:none; color:red;">ğŸ—‘</button> : ''}
                    </td>
                </tr>`;
            }
        });
        document.getElementById('mainTbody').innerHTML = html;
    }

    function makeLog(type) {
        if(!user) return alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        let c = document.getElementById('selItem').value, q = parseFloat(document.getElementById('inQty').value), d = document.getElementById('inDoc').value, e = document.getElementById('selEnt').value;
        if(c && q && d) {
            db.logs.push({ c, q, t: type, d, e, dt: new Date().toLocaleString(), u: user.name });
            render(); alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
        } else { alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
    }

    function saveItem() { 
        let n = document.getElementById('itemN').value, c = document.getElementById('itemC').value;
        if(n && c) { db.items.push({n, c}); render(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); } 
    }
    function saveStaff() { 
        let u = document.getElementById('staffU').value, p = document.getElementById('staffP').value;
        if(u && p) { db.staff.push({u, p}); render(); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù"); } 
    }
    function saveEntity() { 
        let n = document.getElementById('entN').value, t = document.getElementById('entT').value;
        if(n) { db.entities.push({n, t}); render(); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø±Ù"); } 
    }
    function delI(i) { if(confirm("Ø­Ø°ÙØŸ")) { db.items.splice(i,1); render(); } }

    function printC(code) {
        let item = db.items.find(i => i.c == code);
        let logs = db.logs.filter(l => l.code == code);
        let h = `<div style="direction:rtl; padding:20px;"><h2>ÙƒØ§Ø±ØªØ© ØµÙ†Ù: ${item.n}</h2><table border="1" style="width:100%; border-collapse:collapse; text-align:center;">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥Ø°Ù†</th><th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th></tr></thead><tbody>`;
        let b = 0; logs.forEach(l => { b += (l.t=='ÙˆØ§Ø±Ø¯'?l.q:-l.q); h += <tr><td>${l.dt}</td><td>${l.t}</td><td>${l.q}</td><td>${l.d}</td><td>${l.u}</td></tr>; });
        h += </tbody></table><h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${b}</h3></div>;
        document.getElementById('printView').innerHTML = h; window.print();
    }
    render();
</script>
</body>
</html>
